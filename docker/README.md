# Docker Setup & Deployment

This directory contains all Docker-related configuration files for the tide recorder server with enhanced security features.

## Directory Structure

```
docker/
├── secrets/               # Docker secrets (auto-generated by deploy.ps1)
│   ├── secret_key.txt     # Flask session encryption key
│   ├── admin_user.txt     # Web interface username
│   └── admin_pass.txt     # Web interface password
├── .dockerignore          # Files excluded from Docker context
├── Dockerfile             # Multi-stage container build with security features
├── docker-compose.yml     # Production-ready orchestration with secrets
└── README.md             # This file
```

## Security Features

### Docker Secrets
- Credentials stored in secure Docker secrets instead of environment variables
- Secret files are mounted at `/run/secrets/` inside containers
- Application reads from secret files when `*_FILE` environment variables are set

### Container Security
- Multi-stage build for smaller image size
- Non-root user execution (appuser)
- Read-only SSL certificate volumes
- No new privileges security option
- Health check endpoint for monitoring

### Volume Management
- Persistent data storage with Docker volumes
- SSL certificates managed through dedicated volume
- Uploads directory persisted across container restarts

## Deployment Options

### Option 1: Automated Deployment (Recommended)
Use the main deployment script from project root:
```bash
# From project root directory
./deploy.ps1
```

This script automatically:
- Generates secure credentials
- Creates Docker secrets
- Sets up SSL certificate volumes
- Builds and starts the application

### Option 2: Manual Deployment
Deploy directly from this directory:
```bash
# Navigate to docker directory
cd docker

# Start the application
docker-compose up -d --build

# View logs
docker-compose logs -f

# Stop the application
docker-compose down
```

## SSL Certificate Setup

### Automatic (via deploy.ps1)
The deploy script automatically handles SSL certificates:
- Creates `ssl_certs` Docker volume
- Copies `cert.pem` and `key.pem` from project root
- Mounts certificates as read-only in container

### Manual SSL Setup
If deploying manually, ensure SSL certificates are available:

```bash
# Create SSL volume
docker volume create ssl_certs

# Copy certificates to volume (from project root)
docker run --rm -v ssl_certs:/certs -v .:/host alpine sh -c "cp /host/cert.pem /host/key.pem /certs/"
```

## Configuration

### Docker Secrets
Replace placeholder values in `secrets/` directory:
```bash
# Example secret values (replace with actual values)
echo "your-secret-flask-key" > secrets/secret_key.txt
echo "your-admin-username" > secrets/admin_user.txt
echo "your-secure-password" > secrets/admin_pass.txt
```

### Environment Variables
The application uses these environment variables for Docker secrets:
- `SECRET_KEY_FILE=/run/secrets/secret_key`
- `ADMIN_USER_FILE=/run/secrets/admin_user`
- `ADMIN_PASS_FILE=/run/secrets/admin_pass`
- `SSL_CERT_PATH=/app/certs/cert.pem`
- `SSL_KEY_PATH=/app/certs/key.pem`

## Health Monitoring

### Health Check Endpoint
The application includes a health check at `/health`:
```json
{
  "status": "healthy",
  "timestamp": "2025-01-15T10:30:00.000Z"
}
```

### Container Health Status
```bash
# Check container health
docker ps
# Look for "healthy" status in the STATUS column

# View health check logs
docker inspect tide-recorder-server-https | grep -A 10 Health
```

## Troubleshooting

### Common Issues

1. **SSL Certificate Errors**
   - Ensure `cert.pem` and `key.pem` exist in project root
   - Check SSL volume: `docker volume inspect ssl_certs`

2. **Permission Denied**
   - Container runs as non-root user `appuser`
   - Ensure volume permissions allow container access

3. **Secret File Not Found**
   - Check secrets exist: `ls docker/secrets/`
   - Verify docker-compose.yml secret paths

### Debugging Commands
```bash
# View container logs
docker-compose logs -f web

# Execute shell in container
docker-compose exec web /bin/bash

# Check mounted volumes
docker-compose exec web ls -la /app/certs/
docker-compose exec web ls -la /run/secrets/

# Inspect volumes
docker volume inspect ssl_certs uploads_data
```

## Maintenance

### Updating the Application
```bash
# Pull latest changes and rebuild
cd docker
docker-compose down
docker-compose up -d --build
```

### Cleaning Up
```bash
# Stop and remove containers
docker-compose down

# Remove unused Docker resources
docker system prune -f

# Remove specific volumes (WARNING: data loss)
docker volume rm ssl_certs uploads_data
```

### Backup & Restore
```bash
# Backup uploads volume
docker run --rm -v uploads_data:/data -v $(pwd):/backup alpine tar czf /backup/uploads-backup.tar.gz -C /data .

# Restore uploads volume
docker run --rm -v uploads_data:/data -v $(pwd):/backup alpine tar xzf /backup/uploads-backup.tar.gz -C /data
```

## Production Considerations

### Security Hardening
- Use proper SSL certificates from CA instead of self-signed
- Enable firewall rules to restrict access
- Regularly update base images and dependencies
- Monitor container logs for security events

### Performance Optimization
- Configure resource limits in docker-compose.yml
- Use external database for production workloads
- Implement log rotation and monitoring
- Consider using reverse proxy (nginx) for SSL termination

### High Availability
- Use Docker Swarm or Kubernetes for orchestration
- Implement database backups and replication
- Set up monitoring and alerting
- Configure load balancing for multiple instances